#!/bin/bash

# ------------------------------------------------------------------------------
# PATH
# ------------------------------------------------------------------------------
export PATH="$HOME/dotfiles/bin:$HOME/.local/bin:$PATH"

# Dumb terminal / Emacs comint — skip all fancy setup
if [[ "$TERM" == "dumb" || "$INSIDE_EMACS" == *comint* ]]; then
    PS1="$ "
    return
fi

# ------------------------------------------------------------------------------
# History
# ------------------------------------------------------------------------------
HISTSIZE=5000000
HISTFILESIZE=5000000
HISTTIMEFORMAT="%F %T  "
HISTCONTROL=ignorespace:erasedups
shopt -s histappend

# ------------------------------------------------------------------------------
# Aliases
# ------------------------------------------------------------------------------
alias ls='ls -GFh --color=auto'
alias ll='ls -lh --color=auto'

# ------------------------------------------------------------------------------
# Emacs keybindings
# ------------------------------------------------------------------------------
set -o emacs

# ------------------------------------------------------------------------------
# Bash completion
# ------------------------------------------------------------------------------
if [ -f /usr/share/bash-completion/bash_completion ]; then
    source /usr/share/bash-completion/bash_completion
elif [ -f /etc/bash_completion ]; then
    source /etc/bash_completion
fi

# ------------------------------------------------------------------------------
# Emacs vterm integration
# ------------------------------------------------------------------------------
vterm_printf() {
    if [ -n "$TMUX" ] && { [ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ]; }; then
        printf "\ePtmux;\e\e]%s\007\e\\" "$1"
    elif [ "${TERM%%-*}" = "screen" ]; then
        printf "\eP\e]%s\007\e\\" "$1"
    else
        printf "\e]%s\e\\" "$1"
    fi
}

if [[ "$INSIDE_EMACS" == "vterm" ]]; then
    vterm_prompt_end() {
        vterm_printf "51;A$(whoami)@$(hostname):$(pwd)"
    }

    # Source the official vterm shell integration if available
    VTERM_BASH="${EMACS_VTERM_PATH}/etc/emacs-vterm-bash.sh"
    if [ -f "$VTERM_BASH" ]; then
        source "$VTERM_BASH"
    fi
fi

# ------------------------------------------------------------------------------
# Lazy conda
# ------------------------------------------------------------------------------
_lazy_conda_init() {
    unset -f conda mamba activate
    local conda_setup
    if [ -f "$HOME/miniforge3/etc/profile.d/conda.sh" ]; then
        conda_setup="$HOME/miniforge3"
    elif [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
        conda_setup="$HOME/miniconda3"
    elif [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
        conda_setup="$HOME/anaconda3"
    fi
    if [ -n "$conda_setup" ]; then
        eval "$("$conda_setup/bin/conda" shell.bash hook)"
        if [ -f "$conda_setup/etc/profile.d/mamba.sh" ]; then
            source "$conda_setup/etc/profile.d/mamba.sh"
        fi
    fi
}

conda()    { _lazy_conda_init; conda "$@"; }
mamba()    { _lazy_conda_init; mamba "$@"; }
activate() { _lazy_conda_init; conda activate "$@"; }

# ------------------------------------------------------------------------------
# Starship prompt (must come after vterm setup)
# ------------------------------------------------------------------------------
eval "$(starship init bash)"

# Vterm directory tracking — must come after starship since starship overwrites PS1
if [[ "$INSIDE_EMACS" == "vterm" ]]; then
    PROMPT_COMMAND="${PROMPT_COMMAND:+$PROMPT_COMMAND; }vterm_prompt_end"
fi
